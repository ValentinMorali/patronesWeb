import * as ɵngcc0 from '@angular/core';

const _c0 = ["count-down"];
const _c1 = ["*"];
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
import { Component, ElementRef, Input, Output, EventEmitter, ChangeDetectionStrategy, ViewEncapsulation, } from '@angular/core';
import { Timer } from './countdown.timer';
import { CountdownConfig } from './countdown.config';
var CountdownComponent = /** @class */ (function () {
    function CountdownComponent(el, timer, cog) {
        this.el = el;
        this.timer = timer;
        this.cog = cog;
        this.frequency = 1000;
        this._notify = {};
        this.hands = [];
        this.left = 0;
        this.paused = false;
        /** 两种情况会触发：时间终止或调用 `stop()` */
        this.stoped = false;
        this.start = new EventEmitter();
        this.finished = new EventEmitter();
        this.notify = new EventEmitter();
        this.event = new EventEmitter();
    }
    /** 开始，当 `demand: false` 时触发 */
    CountdownComponent.prototype.begin = function () {
        this.paused = false;
        this.start.emit();
        this.callEvent('start');
    };
    /** 重新开始 */
    CountdownComponent.prototype.restart = function () {
        if (!this.stoped)
            this.destroy();
        this.init();
        this.callEvent('restart');
    };
    /** 停止 */
    CountdownComponent.prototype.stop = function () {
        if (this.stoped)
            return;
        this.stoped = true;
        this.destroy();
        this.callEvent('stop');
    };
    /** 暂停（限未终止有效） */
    CountdownComponent.prototype.pause = function () {
        if (this.stoped || this.paused)
            return;
        this.paused = true;
        this.callEvent('pause');
    };
    /** 恢复 */
    CountdownComponent.prototype.resume = function () {
        if (this.stoped || !this.paused)
            return;
        this.paused = false;
        this.callEvent('resume');
    };
    CountdownComponent.prototype.callEvent = function (action) {
        this.event.emit({ action: action, left: this.left });
    };
    CountdownComponent.prototype.init = function () {
        var me = this;
        me.config = __assign({}, new CountdownConfig(), me.cog, me.config);
        var el = me.el.nativeElement;
        me.paused = me.config.demand;
        me.stoped = false;
        // 分析markup
        var tmpl = el.innerHTML || me.config.template;
        me.config.varRegular.lastIndex = 0;
        el.innerHTML = tmpl.replace(me.config.varRegular, function (str, type) {
            // 时钟频率校正.
            if (type === 'u' || type === 's-ext')
                me.frequency = 100;
            // 生成hand的markup
            var content = '';
            if (type === 's-ext') {
                me.hands.push({ type: 's' });
                me.hands.push({ type: 'u' });
                content =
                    me.html('', 's', 'handlet') +
                        me.html('.', '', 'digital') +
                        me.html('', 'u', 'handlet');
            }
            else {
                me.hands.push({ type: type });
            }
            return me.html(content, type, 'hand');
        });
        var clock = me.config.clock;
        me.hands.forEach(function (hand) {
            var type = hand.type;
            var base = 100, i;
            hand.node = el.querySelector(".hand-" + type);
            // radix, bits 初始化
            for (i = clock.length - 3; i > -1; i -= 3) {
                if (type === clock[i]) {
                    break;
                }
                base *= clock[i + 1];
            }
            hand.base = base;
            hand.radix = clock[i + 1];
            hand.bits = clock[i + 2];
        });
        me.getLeft();
        me.reflow(0, true);
        // bind reflow to me
        var _reflow = me.reflow;
        me.reflow = function (count) {
            if (count === void 0) { count = 0; }
            return _reflow.apply(me, [count]);
        };
        // 构建 notify
        if (me.config.notify) {
            me.config.notify.forEach(function (time) {
                if (time < 1)
                    throw new Error("the notify config must be a positive integer.");
                time = time * 1000;
                time = time - (time % me.frequency);
                me._notify[time] = true;
            });
        }
        me.timer.add(me.reflow, me.frequency);
        // show
        el.style.display = 'inline';
        this.timer.start();
        return me;
    };
    CountdownComponent.prototype.destroy = function () {
        this.timer.remove(this.reflow);
        return this;
    };
    /**
     * 更新时钟
     */
    CountdownComponent.prototype.reflow = function (count, force) {
        if (count === void 0) { count = 0; }
        if (force === void 0) { force = false; }
        var me = this;
        if (!force && (me.paused || me.stoped))
            return;
        me.left = me.left - me.frequency * count;
        me.hands.forEach(function (hand) {
            hand.lastValue = hand.value;
            hand.value = Math.floor(me.left / hand.base) % hand.radix;
        });
        me.repaint();
        if (me._notify[me.left]) {
            me.notify.emit(me.left);
            me.callEvent('notify');
        }
        if (me.left < 1) {
            me.finished.emit(0);
            me.stoped = true;
            me.callEvent('finished');
            me.destroy();
        }
    };
    /**
     * 重绘时钟
     */
    CountdownComponent.prototype.repaint = function () {
        var me = this;
        if (me.config.repaint) {
            me.config.repaint.apply(me);
            return;
        }
        var content;
        me.hands.forEach(function (hand) {
            if (hand.lastValue !== hand.value) {
                content = '';
                me.toDigitals(hand.value, hand.bits).forEach(function (digital) {
                    content += me.html(digital.toString(), '', 'digital');
                });
                hand.node.innerHTML = content;
            }
        });
    };
    /**
     * 获取倒计时剩余帧数
     */
    CountdownComponent.prototype.getLeft = function () {
        var me = this;
        var left = me.config.leftTime * 1000;
        var end = me.config.stopTime;
        if (!left && end)
            left = end - new Date().getTime();
        me.left = left - (left % me.frequency);
    };
    /**
     * 生成需要的html代码，辅助工具
     */
    CountdownComponent.prototype.html = function (con, className, type) {
        switch (type) {
            case 'hand':
            case 'handlet':
                className = type + ' hand-' + className;
                break;
            case 'digital':
                if (con === '.') {
                    className = type + ' ' + type + '-point ' + className;
                }
                else {
                    className = type + ' ' + type + '-' + con + ' ' + className;
                }
                break;
        }
        return '<span class="' + className + '">' + con + '</span>';
    };
    /**
     * 把值转换为独立的数字形式
     */
    CountdownComponent.prototype.toDigitals = function (value, bits) {
        value = value < 0 ? 0 : value;
        var digitals = [];
        // 把时、分、秒等换算成数字.
        while (bits--) {
            digitals[bits] = value % 10;
            value = Math.floor(value / 10);
        }
        return digitals;
    };
    CountdownComponent.prototype.ngOnInit = function () {
        this.init();
        if (!this.config.demand)
            this.begin();
    };
    CountdownComponent.prototype.ngOnDestroy = function () {
        this.destroy();
    };
    CountdownComponent.prototype.ngOnChanges = function (changes) {
        if (!changes.config.firstChange) {
            this.restart();
        }
    };
    /** @nocollapse */
    CountdownComponent.ctorParameters = function () { return [
        { type: ElementRef },
        { type: Timer },
        { type: CountdownConfig }
    ]; };
    CountdownComponent.propDecorators = {
        config: [{ type: Input }],
        start: [{ type: Output }],
        finished: [{ type: Output }],
        notify: [{ type: Output }],
        event: [{ type: Output }]
    };
CountdownComponent.ngComponentDef = ɵngcc0.ɵɵdefineComponent({ type: CountdownComponent, selectors: [["countdown"]], factory: function CountdownComponent_Factory(t) { return new (t || CountdownComponent)(ɵngcc0.ɵɵdirectiveInject(ElementRef), ɵngcc0.ɵɵdirectiveInject(Timer), ɵngcc0.ɵɵdirectiveInject(CountdownConfig)); }, hostBindings: function CountdownComponent_HostBindings(rf, ctx, elIndex) { if (rf & 1) {
        ɵngcc0.ɵɵstyling(_c0);
    } if (rf & 2) {
        ɵngcc0.ɵɵclassProp(0, true);
        ɵngcc0.ɵɵstylingApply();
    } }, inputs: { config: "config" }, outputs: { start: "start", finished: "finished", notify: "notify", event: "event" }, features: [ɵngcc0.ɵɵNgOnChangesFeature()], ngContentSelectors: _c1, consts: 1, vars: 0, template: function CountdownComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵprojectionDef();
        ɵngcc0.ɵɵprojection(0);
    } }, styles: ["\n      countdown {\n        display: none;\n      }\n    "], encapsulation: 2, changeDetection: 0 });
/*@__PURE__*/ ɵngcc0.ɵsetClassMetadata(CountdownComponent, [{
        type: Component,
        args: [{
                selector: 'countdown',
                template: "\n    <ng-content></ng-content>\n  ",
                host: { '[class.count-down]': 'true' },
                encapsulation: ViewEncapsulation.None,
                changeDetection: ChangeDetectionStrategy.OnPush,
                styles: ["\n      countdown {\n        display: none;\n      }\n    "]
            }]
    }], function () { return [{ type: ElementRef }, { type: Timer }, { type: CountdownConfig }]; }, { el: [], timer: [], cog: [], frequency: [], _notify: [], hands: [], left: [], paused: [], stoped: [], start: [{
            type: Output
        }], finished: [{
            type: Output
        }], notify: [{
            type: Output
        }], event: [{
            type: Output
        }], begin: [], restart: [], stop: [], pause: [], resume: [], callEvent: [], init: [], destroy: [], reflow: [], repaint: [], getLeft: [], html: [], toDigitals: [], ngOnInit: [], ngOnDestroy: [], ngOnChanges: [], config: [{
            type: Input
        }] });
    return CountdownComponent;
}());
export { CountdownComponent };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImM6L3BhdHJvbmVzL3BhdHJvbmVzU2lkZXJjYVdlYi9Gcm9udGVuZC9ub2RlX21vZHVsZXMvbmd4LWNvdW50ZG93bi9lc201L3NyYy9jb3VudGRvd24uY29tcG9uZW50LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O01BbVBNLEFBVUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Y0FhQSIsImZpbGUiOiJjb3VudGRvd24uY29tcG9uZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIF9fYXNzaWduID0gKHRoaXMgJiYgdGhpcy5fX2Fzc2lnbikgfHwgZnVuY3Rpb24gKCkge1xuICAgIF9fYXNzaWduID0gT2JqZWN0LmFzc2lnbiB8fCBmdW5jdGlvbih0KSB7XG4gICAgICAgIGZvciAodmFyIHMsIGkgPSAxLCBuID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IG47IGkrKykge1xuICAgICAgICAgICAgcyA9IGFyZ3VtZW50c1tpXTtcbiAgICAgICAgICAgIGZvciAodmFyIHAgaW4gcykgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzLCBwKSlcbiAgICAgICAgICAgICAgICB0W3BdID0gc1twXTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdDtcbiAgICB9O1xuICAgIHJldHVybiBfX2Fzc2lnbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xufTtcbmltcG9ydCB7IENvbXBvbmVudCwgRWxlbWVudFJlZiwgSW5wdXQsIE91dHB1dCwgRXZlbnRFbWl0dGVyLCBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSwgVmlld0VuY2Fwc3VsYXRpb24sIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBUaW1lciB9IGZyb20gJy4vY291bnRkb3duLnRpbWVyJztcbmltcG9ydCB7IENvdW50ZG93bkNvbmZpZyB9IGZyb20gJy4vY291bnRkb3duLmNvbmZpZyc7XG52YXIgQ291bnRkb3duQ29tcG9uZW50ID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkge1xuICAgIGZ1bmN0aW9uIENvdW50ZG93bkNvbXBvbmVudChlbCwgdGltZXIsIGNvZykge1xuICAgICAgICB0aGlzLmVsID0gZWw7XG4gICAgICAgIHRoaXMudGltZXIgPSB0aW1lcjtcbiAgICAgICAgdGhpcy5jb2cgPSBjb2c7XG4gICAgICAgIHRoaXMuZnJlcXVlbmN5ID0gMTAwMDtcbiAgICAgICAgdGhpcy5fbm90aWZ5ID0ge307XG4gICAgICAgIHRoaXMuaGFuZHMgPSBbXTtcbiAgICAgICAgdGhpcy5sZWZ0ID0gMDtcbiAgICAgICAgdGhpcy5wYXVzZWQgPSBmYWxzZTtcbiAgICAgICAgLyoqIOS4pOenjeaDheWGteS8muinpuWPke+8muaXtumXtOe7iOatouaIluiwg+eUqCBgc3RvcCgpYCAqL1xuICAgICAgICB0aGlzLnN0b3BlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLnN0YXJ0ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgICAgICB0aGlzLmZpbmlzaGVkID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgICAgICB0aGlzLm5vdGlmeSA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICAgICAgdGhpcy5ldmVudCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICB9XG4gICAgLyoqIOW8gOWni++8jOW9kyBgZGVtYW5kOiBmYWxzZWAg5pe26Kem5Y+RICovXG4gICAgQ291bnRkb3duQ29tcG9uZW50LnByb3RvdHlwZS5iZWdpbiA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdGhpcy5wYXVzZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5zdGFydC5lbWl0KCk7XG4gICAgICAgIHRoaXMuY2FsbEV2ZW50KCdzdGFydCcpO1xuICAgIH07XG4gICAgLyoqIOmHjeaWsOW8gOWniyAqL1xuICAgIENvdW50ZG93bkNvbXBvbmVudC5wcm90b3R5cGUucmVzdGFydCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKCF0aGlzLnN0b3BlZClcbiAgICAgICAgICAgIHRoaXMuZGVzdHJveSgpO1xuICAgICAgICB0aGlzLmluaXQoKTtcbiAgICAgICAgdGhpcy5jYWxsRXZlbnQoJ3Jlc3RhcnQnKTtcbiAgICB9O1xuICAgIC8qKiDlgZzmraIgKi9cbiAgICBDb3VudGRvd25Db21wb25lbnQucHJvdG90eXBlLnN0b3AgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGlmICh0aGlzLnN0b3BlZClcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgdGhpcy5zdG9wZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLmRlc3Ryb3koKTtcbiAgICAgICAgdGhpcy5jYWxsRXZlbnQoJ3N0b3AnKTtcbiAgICB9O1xuICAgIC8qKiDmmoLlgZzvvIjpmZDmnKrnu4jmraLmnInmlYjvvIkgKi9cbiAgICBDb3VudGRvd25Db21wb25lbnQucHJvdG90eXBlLnBhdXNlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAodGhpcy5zdG9wZWQgfHwgdGhpcy5wYXVzZWQpXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIHRoaXMucGF1c2VkID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5jYWxsRXZlbnQoJ3BhdXNlJyk7XG4gICAgfTtcbiAgICAvKiog5oGi5aSNICovXG4gICAgQ291bnRkb3duQ29tcG9uZW50LnByb3RvdHlwZS5yZXN1bWUgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGlmICh0aGlzLnN0b3BlZCB8fCAhdGhpcy5wYXVzZWQpXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIHRoaXMucGF1c2VkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuY2FsbEV2ZW50KCdyZXN1bWUnKTtcbiAgICB9O1xuICAgIENvdW50ZG93bkNvbXBvbmVudC5wcm90b3R5cGUuY2FsbEV2ZW50ID0gZnVuY3Rpb24gKGFjdGlvbikge1xuICAgICAgICB0aGlzLmV2ZW50LmVtaXQoeyBhY3Rpb246IGFjdGlvbiwgbGVmdDogdGhpcy5sZWZ0IH0pO1xuICAgIH07XG4gICAgQ291bnRkb3duQ29tcG9uZW50LnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgbWUgPSB0aGlzO1xuICAgICAgICBtZS5jb25maWcgPSBfX2Fzc2lnbih7fSwgbmV3IENvdW50ZG93bkNvbmZpZygpLCBtZS5jb2csIG1lLmNvbmZpZyk7XG4gICAgICAgIHZhciBlbCA9IG1lLmVsLm5hdGl2ZUVsZW1lbnQ7XG4gICAgICAgIG1lLnBhdXNlZCA9IG1lLmNvbmZpZy5kZW1hbmQ7XG4gICAgICAgIG1lLnN0b3BlZCA9IGZhbHNlO1xuICAgICAgICAvLyDliIbmnpBtYXJrdXBcbiAgICAgICAgdmFyIHRtcGwgPSBlbC5pbm5lckhUTUwgfHwgbWUuY29uZmlnLnRlbXBsYXRlO1xuICAgICAgICBtZS5jb25maWcudmFyUmVndWxhci5sYXN0SW5kZXggPSAwO1xuICAgICAgICBlbC5pbm5lckhUTUwgPSB0bXBsLnJlcGxhY2UobWUuY29uZmlnLnZhclJlZ3VsYXIsIGZ1bmN0aW9uIChzdHIsIHR5cGUpIHtcbiAgICAgICAgICAgIC8vIOaXtumSn+mikeeOh+agoeatoy5cbiAgICAgICAgICAgIGlmICh0eXBlID09PSAndScgfHwgdHlwZSA9PT0gJ3MtZXh0JylcbiAgICAgICAgICAgICAgICBtZS5mcmVxdWVuY3kgPSAxMDA7XG4gICAgICAgICAgICAvLyDnlJ/miJBoYW5k55qEbWFya3VwXG4gICAgICAgICAgICB2YXIgY29udGVudCA9ICcnO1xuICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzLWV4dCcpIHtcbiAgICAgICAgICAgICAgICBtZS5oYW5kcy5wdXNoKHsgdHlwZTogJ3MnIH0pO1xuICAgICAgICAgICAgICAgIG1lLmhhbmRzLnB1c2goeyB0eXBlOiAndScgfSk7XG4gICAgICAgICAgICAgICAgY29udGVudCA9XG4gICAgICAgICAgICAgICAgICAgIG1lLmh0bWwoJycsICdzJywgJ2hhbmRsZXQnKSArXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5odG1sKCcuJywgJycsICdkaWdpdGFsJykgK1xuICAgICAgICAgICAgICAgICAgICAgICAgbWUuaHRtbCgnJywgJ3UnLCAnaGFuZGxldCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgbWUuaGFuZHMucHVzaCh7IHR5cGU6IHR5cGUgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbWUuaHRtbChjb250ZW50LCB0eXBlLCAnaGFuZCcpO1xuICAgICAgICB9KTtcbiAgICAgICAgdmFyIGNsb2NrID0gbWUuY29uZmlnLmNsb2NrO1xuICAgICAgICBtZS5oYW5kcy5mb3JFYWNoKGZ1bmN0aW9uIChoYW5kKSB7XG4gICAgICAgICAgICB2YXIgdHlwZSA9IGhhbmQudHlwZTtcbiAgICAgICAgICAgIHZhciBiYXNlID0gMTAwLCBpO1xuICAgICAgICAgICAgaGFuZC5ub2RlID0gZWwucXVlcnlTZWxlY3RvcihcIi5oYW5kLVwiICsgdHlwZSk7XG4gICAgICAgICAgICAvLyByYWRpeCwgYml0cyDliJ3lp4vljJZcbiAgICAgICAgICAgIGZvciAoaSA9IGNsb2NrLmxlbmd0aCAtIDM7IGkgPiAtMTsgaSAtPSAzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IGNsb2NrW2ldKSB7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBiYXNlICo9IGNsb2NrW2kgKyAxXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGhhbmQuYmFzZSA9IGJhc2U7XG4gICAgICAgICAgICBoYW5kLnJhZGl4ID0gY2xvY2tbaSArIDFdO1xuICAgICAgICAgICAgaGFuZC5iaXRzID0gY2xvY2tbaSArIDJdO1xuICAgICAgICB9KTtcbiAgICAgICAgbWUuZ2V0TGVmdCgpO1xuICAgICAgICBtZS5yZWZsb3coMCwgdHJ1ZSk7XG4gICAgICAgIC8vIGJpbmQgcmVmbG93IHRvIG1lXG4gICAgICAgIHZhciBfcmVmbG93ID0gbWUucmVmbG93O1xuICAgICAgICBtZS5yZWZsb3cgPSBmdW5jdGlvbiAoY291bnQpIHtcbiAgICAgICAgICAgIGlmIChjb3VudCA9PT0gdm9pZCAwKSB7IGNvdW50ID0gMDsgfVxuICAgICAgICAgICAgcmV0dXJuIF9yZWZsb3cuYXBwbHkobWUsIFtjb3VudF0pO1xuICAgICAgICB9O1xuICAgICAgICAvLyDmnoTlu7ogbm90aWZ5XG4gICAgICAgIGlmIChtZS5jb25maWcubm90aWZ5KSB7XG4gICAgICAgICAgICBtZS5jb25maWcubm90aWZ5LmZvckVhY2goZnVuY3Rpb24gKHRpbWUpIHtcbiAgICAgICAgICAgICAgICBpZiAodGltZSA8IDEpXG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcInRoZSBub3RpZnkgY29uZmlnIG11c3QgYmUgYSBwb3NpdGl2ZSBpbnRlZ2VyLlwiKTtcbiAgICAgICAgICAgICAgICB0aW1lID0gdGltZSAqIDEwMDA7XG4gICAgICAgICAgICAgICAgdGltZSA9IHRpbWUgLSAodGltZSAlIG1lLmZyZXF1ZW5jeSk7XG4gICAgICAgICAgICAgICAgbWUuX25vdGlmeVt0aW1lXSA9IHRydWU7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBtZS50aW1lci5hZGQobWUucmVmbG93LCBtZS5mcmVxdWVuY3kpO1xuICAgICAgICAvLyBzaG93XG4gICAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSAnaW5saW5lJztcbiAgICAgICAgdGhpcy50aW1lci5zdGFydCgpO1xuICAgICAgICByZXR1cm4gbWU7XG4gICAgfTtcbiAgICBDb3VudGRvd25Db21wb25lbnQucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHRoaXMudGltZXIucmVtb3ZlKHRoaXMucmVmbG93KTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfTtcbiAgICAvKipcbiAgICAgKiDmm7TmlrDml7bpkp9cbiAgICAgKi9cbiAgICBDb3VudGRvd25Db21wb25lbnQucHJvdG90eXBlLnJlZmxvdyA9IGZ1bmN0aW9uIChjb3VudCwgZm9yY2UpIHtcbiAgICAgICAgaWYgKGNvdW50ID09PSB2b2lkIDApIHsgY291bnQgPSAwOyB9XG4gICAgICAgIGlmIChmb3JjZSA9PT0gdm9pZCAwKSB7IGZvcmNlID0gZmFsc2U7IH1cbiAgICAgICAgdmFyIG1lID0gdGhpcztcbiAgICAgICAgaWYgKCFmb3JjZSAmJiAobWUucGF1c2VkIHx8IG1lLnN0b3BlZCkpXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIG1lLmxlZnQgPSBtZS5sZWZ0IC0gbWUuZnJlcXVlbmN5ICogY291bnQ7XG4gICAgICAgIG1lLmhhbmRzLmZvckVhY2goZnVuY3Rpb24gKGhhbmQpIHtcbiAgICAgICAgICAgIGhhbmQubGFzdFZhbHVlID0gaGFuZC52YWx1ZTtcbiAgICAgICAgICAgIGhhbmQudmFsdWUgPSBNYXRoLmZsb29yKG1lLmxlZnQgLyBoYW5kLmJhc2UpICUgaGFuZC5yYWRpeDtcbiAgICAgICAgfSk7XG4gICAgICAgIG1lLnJlcGFpbnQoKTtcbiAgICAgICAgaWYgKG1lLl9ub3RpZnlbbWUubGVmdF0pIHtcbiAgICAgICAgICAgIG1lLm5vdGlmeS5lbWl0KG1lLmxlZnQpO1xuICAgICAgICAgICAgbWUuY2FsbEV2ZW50KCdub3RpZnknKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobWUubGVmdCA8IDEpIHtcbiAgICAgICAgICAgIG1lLmZpbmlzaGVkLmVtaXQoMCk7XG4gICAgICAgICAgICBtZS5zdG9wZWQgPSB0cnVlO1xuICAgICAgICAgICAgbWUuY2FsbEV2ZW50KCdmaW5pc2hlZCcpO1xuICAgICAgICAgICAgbWUuZGVzdHJveSgpO1xuICAgICAgICB9XG4gICAgfTtcbiAgICAvKipcbiAgICAgKiDph43nu5jml7bpkp9cbiAgICAgKi9cbiAgICBDb3VudGRvd25Db21wb25lbnQucHJvdG90eXBlLnJlcGFpbnQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHZhciBtZSA9IHRoaXM7XG4gICAgICAgIGlmIChtZS5jb25maWcucmVwYWludCkge1xuICAgICAgICAgICAgbWUuY29uZmlnLnJlcGFpbnQuYXBwbHkobWUpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHZhciBjb250ZW50O1xuICAgICAgICBtZS5oYW5kcy5mb3JFYWNoKGZ1bmN0aW9uIChoYW5kKSB7XG4gICAgICAgICAgICBpZiAoaGFuZC5sYXN0VmFsdWUgIT09IGhhbmQudmFsdWUpIHtcbiAgICAgICAgICAgICAgICBjb250ZW50ID0gJyc7XG4gICAgICAgICAgICAgICAgbWUudG9EaWdpdGFscyhoYW5kLnZhbHVlLCBoYW5kLmJpdHMpLmZvckVhY2goZnVuY3Rpb24gKGRpZ2l0YWwpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGVudCArPSBtZS5odG1sKGRpZ2l0YWwudG9TdHJpbmcoKSwgJycsICdkaWdpdGFsJyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgaGFuZC5ub2RlLmlubmVySFRNTCA9IGNvbnRlbnQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH07XG4gICAgLyoqXG4gICAgICog6I635Y+W5YCS6K6h5pe25Ymp5L2Z5bin5pWwXG4gICAgICovXG4gICAgQ291bnRkb3duQ29tcG9uZW50LnByb3RvdHlwZS5nZXRMZWZ0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgbWUgPSB0aGlzO1xuICAgICAgICB2YXIgbGVmdCA9IG1lLmNvbmZpZy5sZWZ0VGltZSAqIDEwMDA7XG4gICAgICAgIHZhciBlbmQgPSBtZS5jb25maWcuc3RvcFRpbWU7XG4gICAgICAgIGlmICghbGVmdCAmJiBlbmQpXG4gICAgICAgICAgICBsZWZ0ID0gZW5kIC0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICAgIG1lLmxlZnQgPSBsZWZ0IC0gKGxlZnQgJSBtZS5mcmVxdWVuY3kpO1xuICAgIH07XG4gICAgLyoqXG4gICAgICog55Sf5oiQ6ZyA6KaB55qEaHRtbOS7o+egge+8jOi+heWKqeW3peWFt1xuICAgICAqL1xuICAgIENvdW50ZG93bkNvbXBvbmVudC5wcm90b3R5cGUuaHRtbCA9IGZ1bmN0aW9uIChjb24sIGNsYXNzTmFtZSwgdHlwZSkge1xuICAgICAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgICAgICAgIGNhc2UgJ2hhbmQnOlxuICAgICAgICAgICAgY2FzZSAnaGFuZGxldCc6XG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gdHlwZSArICcgaGFuZC0nICsgY2xhc3NOYW1lO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnZGlnaXRhbCc6XG4gICAgICAgICAgICAgICAgaWYgKGNvbiA9PT0gJy4nKSB7XG4gICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZSA9IHR5cGUgKyAnICcgKyB0eXBlICsgJy1wb2ludCAnICsgY2xhc3NOYW1lO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gdHlwZSArICcgJyArIHR5cGUgKyAnLScgKyBjb24gKyAnICcgKyBjbGFzc05hbWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAnPHNwYW4gY2xhc3M9XCInICsgY2xhc3NOYW1lICsgJ1wiPicgKyBjb24gKyAnPC9zcGFuPic7XG4gICAgfTtcbiAgICAvKipcbiAgICAgKiDmiorlgLzovazmjaLkuLrni6znq4vnmoTmlbDlrZflvaLlvI9cbiAgICAgKi9cbiAgICBDb3VudGRvd25Db21wb25lbnQucHJvdG90eXBlLnRvRGlnaXRhbHMgPSBmdW5jdGlvbiAodmFsdWUsIGJpdHMpIHtcbiAgICAgICAgdmFsdWUgPSB2YWx1ZSA8IDAgPyAwIDogdmFsdWU7XG4gICAgICAgIHZhciBkaWdpdGFscyA9IFtdO1xuICAgICAgICAvLyDmiorml7bjgIHliIbjgIHnp5LnrYnmjaLnrpfmiJDmlbDlrZcuXG4gICAgICAgIHdoaWxlIChiaXRzLS0pIHtcbiAgICAgICAgICAgIGRpZ2l0YWxzW2JpdHNdID0gdmFsdWUgJSAxMDtcbiAgICAgICAgICAgIHZhbHVlID0gTWF0aC5mbG9vcih2YWx1ZSAvIDEwKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZGlnaXRhbHM7XG4gICAgfTtcbiAgICBDb3VudGRvd25Db21wb25lbnQucHJvdG90eXBlLm5nT25Jbml0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICB0aGlzLmluaXQoKTtcbiAgICAgICAgaWYgKCF0aGlzLmNvbmZpZy5kZW1hbmQpXG4gICAgICAgICAgICB0aGlzLmJlZ2luKCk7XG4gICAgfTtcbiAgICBDb3VudGRvd25Db21wb25lbnQucHJvdG90eXBlLm5nT25EZXN0cm95ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICB0aGlzLmRlc3Ryb3koKTtcbiAgICB9O1xuICAgIENvdW50ZG93bkNvbXBvbmVudC5wcm90b3R5cGUubmdPbkNoYW5nZXMgPSBmdW5jdGlvbiAoY2hhbmdlcykge1xuICAgICAgICBpZiAoIWNoYW5nZXMuY29uZmlnLmZpcnN0Q2hhbmdlKSB7XG4gICAgICAgICAgICB0aGlzLnJlc3RhcnQoKTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgQ291bnRkb3duQ29tcG9uZW50LmRlY29yYXRvcnMgPSBbXG4gICAgICAgIHsgdHlwZTogQ29tcG9uZW50LCBhcmdzOiBbe1xuICAgICAgICAgICAgICAgICAgICBzZWxlY3RvcjogJ2NvdW50ZG93bicsXG4gICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlOiBcIlxcbiAgICA8bmctY29udGVudD48L25nLWNvbnRlbnQ+XFxuICBcIixcbiAgICAgICAgICAgICAgICAgICAgaG9zdDogeyAnW2NsYXNzLmNvdW50LWRvd25dJzogJ3RydWUnIH0sXG4gICAgICAgICAgICAgICAgICAgIGVuY2Fwc3VsYXRpb246IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmUsXG4gICAgICAgICAgICAgICAgICAgIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxuICAgICAgICAgICAgICAgICAgICBzdHlsZXM6IFtcIlxcbiAgICAgIGNvdW50ZG93biB7XFxuICAgICAgICBkaXNwbGF5OiBub25lO1xcbiAgICAgIH1cXG4gICAgXCJdXG4gICAgICAgICAgICAgICAgfV0gfVxuICAgIF07XG4gICAgLyoqIEBub2NvbGxhcHNlICovXG4gICAgQ291bnRkb3duQ29tcG9uZW50LmN0b3JQYXJhbWV0ZXJzID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gW1xuICAgICAgICB7IHR5cGU6IEVsZW1lbnRSZWYgfSxcbiAgICAgICAgeyB0eXBlOiBUaW1lciB9LFxuICAgICAgICB7IHR5cGU6IENvdW50ZG93bkNvbmZpZyB9XG4gICAgXTsgfTtcbiAgICBDb3VudGRvd25Db21wb25lbnQucHJvcERlY29yYXRvcnMgPSB7XG4gICAgICAgIGNvbmZpZzogW3sgdHlwZTogSW5wdXQgfV0sXG4gICAgICAgIHN0YXJ0OiBbeyB0eXBlOiBPdXRwdXQgfV0sXG4gICAgICAgIGZpbmlzaGVkOiBbeyB0eXBlOiBPdXRwdXQgfV0sXG4gICAgICAgIG5vdGlmeTogW3sgdHlwZTogT3V0cHV0IH1dLFxuICAgICAgICBldmVudDogW3sgdHlwZTogT3V0cHV0IH1dXG4gICAgfTtcbiAgICByZXR1cm4gQ291bnRkb3duQ29tcG9uZW50O1xufSgpKTtcbmV4cG9ydCB7IENvdW50ZG93bkNvbXBvbmVudCB9O1xuIl19