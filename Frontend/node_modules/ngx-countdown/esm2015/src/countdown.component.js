import { Component, ElementRef, Input, Output, EventEmitter, ChangeDetectionStrategy, ViewEncapsulation, } from '@angular/core';
import { Timer } from './countdown.timer';
import { CountdownConfig } from './countdown.config';
import * as ɵngcc0 from '@angular/core';

const _c0 = ["count-down"];
const _c1 = ["*"];
export class CountdownComponent {
    constructor(el, timer, cog) {
        this.el = el;
        this.timer = timer;
        this.cog = cog;
        this.frequency = 1000;
        this._notify = {};
        this.hands = [];
        this.left = 0;
        this.paused = false;
        /** 两种情况会触发：时间终止或调用 `stop()` */
        this.stoped = false;
        this.start = new EventEmitter();
        this.finished = new EventEmitter();
        this.notify = new EventEmitter();
        this.event = new EventEmitter();
    }
    /** 开始，当 `demand: false` 时触发 */
    begin() {
        this.paused = false;
        this.start.emit();
        this.callEvent('start');
    }
    /** 重新开始 */
    restart() {
        if (!this.stoped)
            this.destroy();
        this.init();
        this.callEvent('restart');
    }
    /** 停止 */
    stop() {
        if (this.stoped)
            return;
        this.stoped = true;
        this.destroy();
        this.callEvent('stop');
    }
    /** 暂停（限未终止有效） */
    pause() {
        if (this.stoped || this.paused)
            return;
        this.paused = true;
        this.callEvent('pause');
    }
    /** 恢复 */
    resume() {
        if (this.stoped || !this.paused)
            return;
        this.paused = false;
        this.callEvent('resume');
    }
    callEvent(action) {
        this.event.emit({ action, left: this.left });
    }
    init() {
        const me = this;
        me.config = Object.assign({}, new CountdownConfig(), me.cog, me.config);
        const el = me.el.nativeElement;
        me.paused = me.config.demand;
        me.stoped = false;
        // 分析markup
        const tmpl = el.innerHTML || me.config.template;
        me.config.varRegular.lastIndex = 0;
        el.innerHTML = tmpl.replace(me.config.varRegular, (str, type) => {
            // 时钟频率校正.
            if (type === 'u' || type === 's-ext')
                me.frequency = 100;
            // 生成hand的markup
            let content = '';
            if (type === 's-ext') {
                me.hands.push({ type: 's' });
                me.hands.push({ type: 'u' });
                content =
                    me.html('', 's', 'handlet') +
                        me.html('.', '', 'digital') +
                        me.html('', 'u', 'handlet');
            }
            else {
                me.hands.push({ type: type });
            }
            return me.html(content, type, 'hand');
        });
        const clock = me.config.clock;
        me.hands.forEach((hand) => {
            const type = hand.type;
            let base = 100, i;
            hand.node = el.querySelector(`.hand-${type}`);
            // radix, bits 初始化
            for (i = clock.length - 3; i > -1; i -= 3) {
                if (type === clock[i]) {
                    break;
                }
                base *= clock[i + 1];
            }
            hand.base = base;
            hand.radix = clock[i + 1];
            hand.bits = clock[i + 2];
        });
        me.getLeft();
        me.reflow(0, true);
        // bind reflow to me
        const _reflow = me.reflow;
        me.reflow = (count = 0) => {
            return _reflow.apply(me, [count]);
        };
        // 构建 notify
        if (me.config.notify) {
            me.config.notify.forEach((time) => {
                if (time < 1)
                    throw new Error(`the notify config must be a positive integer.`);
                time = time * 1000;
                time = time - (time % me.frequency);
                me._notify[time] = true;
            });
        }
        me.timer.add(me.reflow, me.frequency);
        // show
        el.style.display = 'inline';
        this.timer.start();
        return me;
    }
    destroy() {
        this.timer.remove(this.reflow);
        return this;
    }
    /**
     * 更新时钟
     */
    reflow(count = 0, force = false) {
        const me = this;
        if (!force && (me.paused || me.stoped))
            return;
        me.left = me.left - me.frequency * count;
        me.hands.forEach((hand) => {
            hand.lastValue = hand.value;
            hand.value = Math.floor(me.left / hand.base) % hand.radix;
        });
        me.repaint();
        if (me._notify[me.left]) {
            me.notify.emit(me.left);
            me.callEvent('notify');
        }
        if (me.left < 1) {
            me.finished.emit(0);
            me.stoped = true;
            me.callEvent('finished');
            me.destroy();
        }
    }
    /**
     * 重绘时钟
     */
    repaint() {
        const me = this;
        if (me.config.repaint) {
            me.config.repaint.apply(me);
            return;
        }
        let content;
        me.hands.forEach((hand) => {
            if (hand.lastValue !== hand.value) {
                content = '';
                me.toDigitals(hand.value, hand.bits).forEach((digital) => {
                    content += me.html(digital.toString(), '', 'digital');
                });
                hand.node.innerHTML = content;
            }
        });
    }
    /**
     * 获取倒计时剩余帧数
     */
    getLeft() {
        const me = this;
        let left = me.config.leftTime * 1000;
        const end = me.config.stopTime;
        if (!left && end)
            left = end - new Date().getTime();
        me.left = left - (left % me.frequency);
    }
    /**
     * 生成需要的html代码，辅助工具
     */
    html(con, className, type) {
        switch (type) {
            case 'hand':
            case 'handlet':
                className = type + ' hand-' + className;
                break;
            case 'digital':
                if (con === '.') {
                    className = type + ' ' + type + '-point ' + className;
                }
                else {
                    className = type + ' ' + type + '-' + con + ' ' + className;
                }
                break;
        }
        return '<span class="' + className + '">' + con + '</span>';
    }
    /**
     * 把值转换为独立的数字形式
     */
    toDigitals(value, bits) {
        value = value < 0 ? 0 : value;
        const digitals = [];
        // 把时、分、秒等换算成数字.
        while (bits--) {
            digitals[bits] = value % 10;
            value = Math.floor(value / 10);
        }
        return digitals;
    }
    ngOnInit() {
        this.init();
        if (!this.config.demand)
            this.begin();
    }
    ngOnDestroy() {
        this.destroy();
    }
    ngOnChanges(changes) {
        if (!changes.config.firstChange) {
            this.restart();
        }
    }
}
CountdownComponent.ngComponentDef = ɵngcc0.ɵɵdefineComponent({ type: CountdownComponent, selectors: [["countdown"]], factory: function CountdownComponent_Factory(t) { return new (t || CountdownComponent)(ɵngcc0.ɵɵdirectiveInject(ElementRef), ɵngcc0.ɵɵdirectiveInject(Timer), ɵngcc0.ɵɵdirectiveInject(CountdownConfig)); }, hostBindings: function CountdownComponent_HostBindings(rf, ctx, elIndex) { if (rf & 1) {
        ɵngcc0.ɵɵstyling(_c0);
    } if (rf & 2) {
        ɵngcc0.ɵɵclassProp(0, true);
        ɵngcc0.ɵɵstylingApply();
    } }, inputs: { config: "config" }, outputs: { start: "start", finished: "finished", notify: "notify", event: "event" }, features: [ɵngcc0.ɵɵNgOnChangesFeature()], ngContentSelectors: _c1, consts: 1, vars: 0, template: function CountdownComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵprojectionDef();
        ɵngcc0.ɵɵprojection(0);
    } }, styles: ["\n      countdown {\n        display: none;\n      }\n    "], encapsulation: 2, changeDetection: 0 });
/*@__PURE__*/ ɵngcc0.ɵsetClassMetadata(CountdownComponent, [{
        type: Component,
        args: [{
                selector: 'countdown',
                template: `
    <ng-content></ng-content>
  `,
                host: { '[class.count-down]': 'true' },
                encapsulation: ViewEncapsulation.None,
                changeDetection: ChangeDetectionStrategy.OnPush,
                styles: [`
      countdown {
        display: none;
      }
    `]
            }]
    }], function () { return [{ type: ElementRef }, { type: Timer }, { type: CountdownConfig }]; }, { constructor: [], el: [], timer: [], cog: [], frequency: [], _notify: [], hands: [], left: [], paused: [], stoped: [], start: [{
            type: Output
        }], finished: [{
            type: Output
        }], notify: [{
            type: Output
        }], event: [{
            type: Output
        }], begin: [], restart: [], stop: [], pause: [], resume: [], callEvent: [], init: [], destroy: [], reflow: [], repaint: [], getLeft: [], html: [], toDigitals: [], ngOnInit: [], ngOnDestroy: [], ngOnChanges: [], config: [{
            type: Input
        }] });
/** @nocollapse */
CountdownComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: Timer },
    { type: CountdownConfig }
];
CountdownComponent.propDecorators = {
    config: [{ type: Input }],
    start: [{ type: Output }],
    finished: [{ type: Output }],
    notify: [{ type: Output }],
    event: [{ type: Output }]
};

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImM6L3BhdHJvbmVzL3BhdHJvbmVzU2lkZXJjYVdlYi9Gcm9udGVuZC9ub2RlX21vZHVsZXMvbmd4LWNvdW50ZG93bi9lc20yMDE1L3NyYy9jb3VudGRvd24uY29tcG9uZW50LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7O0FBR0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0NBbU9DLGFBZ0JDIiwiZmlsZSI6ImNvdW50ZG93bi5jb21wb25lbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIEVsZW1lbnRSZWYsIElucHV0LCBPdXRwdXQsIEV2ZW50RW1pdHRlciwgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksIFZpZXdFbmNhcHN1bGF0aW9uLCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVGltZXIgfSBmcm9tICcuL2NvdW50ZG93bi50aW1lcic7XG5pbXBvcnQgeyBDb3VudGRvd25Db25maWcgfSBmcm9tICcuL2NvdW50ZG93bi5jb25maWcnO1xuZXhwb3J0IGNsYXNzIENvdW50ZG93bkNvbXBvbmVudCB7XG4gICAgY29uc3RydWN0b3IoZWwsIHRpbWVyLCBjb2cpIHtcbiAgICAgICAgdGhpcy5lbCA9IGVsO1xuICAgICAgICB0aGlzLnRpbWVyID0gdGltZXI7XG4gICAgICAgIHRoaXMuY29nID0gY29nO1xuICAgICAgICB0aGlzLmZyZXF1ZW5jeSA9IDEwMDA7XG4gICAgICAgIHRoaXMuX25vdGlmeSA9IHt9O1xuICAgICAgICB0aGlzLmhhbmRzID0gW107XG4gICAgICAgIHRoaXMubGVmdCA9IDA7XG4gICAgICAgIHRoaXMucGF1c2VkID0gZmFsc2U7XG4gICAgICAgIC8qKiDkuKTnp43mg4XlhrXkvJrop6blj5HvvJrml7bpl7Tnu4jmraLmiJbosIPnlKggYHN0b3AoKWAgKi9cbiAgICAgICAgdGhpcy5zdG9wZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5zdGFydCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICAgICAgdGhpcy5maW5pc2hlZCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICAgICAgdGhpcy5ub3RpZnkgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgICAgIHRoaXMuZXZlbnQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgfVxuICAgIC8qKiDlvIDlp4vvvIzlvZMgYGRlbWFuZDogZmFsc2VgIOaXtuinpuWPkSAqL1xuICAgIGJlZ2luKCkge1xuICAgICAgICB0aGlzLnBhdXNlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLnN0YXJ0LmVtaXQoKTtcbiAgICAgICAgdGhpcy5jYWxsRXZlbnQoJ3N0YXJ0Jyk7XG4gICAgfVxuICAgIC8qKiDph43mlrDlvIDlp4sgKi9cbiAgICByZXN0YXJ0KCkge1xuICAgICAgICBpZiAoIXRoaXMuc3RvcGVkKVxuICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7XG4gICAgICAgIHRoaXMuaW5pdCgpO1xuICAgICAgICB0aGlzLmNhbGxFdmVudCgncmVzdGFydCcpO1xuICAgIH1cbiAgICAvKiog5YGc5q2iICovXG4gICAgc3RvcCgpIHtcbiAgICAgICAgaWYgKHRoaXMuc3RvcGVkKVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB0aGlzLnN0b3BlZCA9IHRydWU7XG4gICAgICAgIHRoaXMuZGVzdHJveSgpO1xuICAgICAgICB0aGlzLmNhbGxFdmVudCgnc3RvcCcpO1xuICAgIH1cbiAgICAvKiog5pqC5YGc77yI6ZmQ5pyq57uI5q2i5pyJ5pWI77yJICovXG4gICAgcGF1c2UoKSB7XG4gICAgICAgIGlmICh0aGlzLnN0b3BlZCB8fCB0aGlzLnBhdXNlZClcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgdGhpcy5wYXVzZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLmNhbGxFdmVudCgncGF1c2UnKTtcbiAgICB9XG4gICAgLyoqIOaBouWkjSAqL1xuICAgIHJlc3VtZSgpIHtcbiAgICAgICAgaWYgKHRoaXMuc3RvcGVkIHx8ICF0aGlzLnBhdXNlZClcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgdGhpcy5wYXVzZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5jYWxsRXZlbnQoJ3Jlc3VtZScpO1xuICAgIH1cbiAgICBjYWxsRXZlbnQoYWN0aW9uKSB7XG4gICAgICAgIHRoaXMuZXZlbnQuZW1pdCh7IGFjdGlvbiwgbGVmdDogdGhpcy5sZWZ0IH0pO1xuICAgIH1cbiAgICBpbml0KCkge1xuICAgICAgICBjb25zdCBtZSA9IHRoaXM7XG4gICAgICAgIG1lLmNvbmZpZyA9IE9iamVjdC5hc3NpZ24oe30sIG5ldyBDb3VudGRvd25Db25maWcoKSwgbWUuY29nLCBtZS5jb25maWcpO1xuICAgICAgICBjb25zdCBlbCA9IG1lLmVsLm5hdGl2ZUVsZW1lbnQ7XG4gICAgICAgIG1lLnBhdXNlZCA9IG1lLmNvbmZpZy5kZW1hbmQ7XG4gICAgICAgIG1lLnN0b3BlZCA9IGZhbHNlO1xuICAgICAgICAvLyDliIbmnpBtYXJrdXBcbiAgICAgICAgY29uc3QgdG1wbCA9IGVsLmlubmVySFRNTCB8fCBtZS5jb25maWcudGVtcGxhdGU7XG4gICAgICAgIG1lLmNvbmZpZy52YXJSZWd1bGFyLmxhc3RJbmRleCA9IDA7XG4gICAgICAgIGVsLmlubmVySFRNTCA9IHRtcGwucmVwbGFjZShtZS5jb25maWcudmFyUmVndWxhciwgKHN0ciwgdHlwZSkgPT4ge1xuICAgICAgICAgICAgLy8g5pe26ZKf6aKR546H5qCh5q2jLlxuICAgICAgICAgICAgaWYgKHR5cGUgPT09ICd1JyB8fCB0eXBlID09PSAncy1leHQnKVxuICAgICAgICAgICAgICAgIG1lLmZyZXF1ZW5jeSA9IDEwMDtcbiAgICAgICAgICAgIC8vIOeUn+aIkGhhbmTnmoRtYXJrdXBcbiAgICAgICAgICAgIGxldCBjb250ZW50ID0gJyc7XG4gICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3MtZXh0Jykge1xuICAgICAgICAgICAgICAgIG1lLmhhbmRzLnB1c2goeyB0eXBlOiAncycgfSk7XG4gICAgICAgICAgICAgICAgbWUuaGFuZHMucHVzaCh7IHR5cGU6ICd1JyB9KTtcbiAgICAgICAgICAgICAgICBjb250ZW50ID1cbiAgICAgICAgICAgICAgICAgICAgbWUuaHRtbCgnJywgJ3MnLCAnaGFuZGxldCcpICtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLmh0bWwoJy4nLCAnJywgJ2RpZ2l0YWwnKSArXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5odG1sKCcnLCAndScsICdoYW5kbGV0Jyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBtZS5oYW5kcy5wdXNoKHsgdHlwZTogdHlwZSB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBtZS5odG1sKGNvbnRlbnQsIHR5cGUsICdoYW5kJyk7XG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCBjbG9jayA9IG1lLmNvbmZpZy5jbG9jaztcbiAgICAgICAgbWUuaGFuZHMuZm9yRWFjaCgoaGFuZCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdHlwZSA9IGhhbmQudHlwZTtcbiAgICAgICAgICAgIGxldCBiYXNlID0gMTAwLCBpO1xuICAgICAgICAgICAgaGFuZC5ub2RlID0gZWwucXVlcnlTZWxlY3RvcihgLmhhbmQtJHt0eXBlfWApO1xuICAgICAgICAgICAgLy8gcmFkaXgsIGJpdHMg5Yid5aeL5YyWXG4gICAgICAgICAgICBmb3IgKGkgPSBjbG9jay5sZW5ndGggLSAzOyBpID4gLTE7IGkgLT0gMykge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSBjbG9ja1tpXSkge1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYmFzZSAqPSBjbG9ja1tpICsgMV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBoYW5kLmJhc2UgPSBiYXNlO1xuICAgICAgICAgICAgaGFuZC5yYWRpeCA9IGNsb2NrW2kgKyAxXTtcbiAgICAgICAgICAgIGhhbmQuYml0cyA9IGNsb2NrW2kgKyAyXTtcbiAgICAgICAgfSk7XG4gICAgICAgIG1lLmdldExlZnQoKTtcbiAgICAgICAgbWUucmVmbG93KDAsIHRydWUpO1xuICAgICAgICAvLyBiaW5kIHJlZmxvdyB0byBtZVxuICAgICAgICBjb25zdCBfcmVmbG93ID0gbWUucmVmbG93O1xuICAgICAgICBtZS5yZWZsb3cgPSAoY291bnQgPSAwKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gX3JlZmxvdy5hcHBseShtZSwgW2NvdW50XSk7XG4gICAgICAgIH07XG4gICAgICAgIC8vIOaehOW7uiBub3RpZnlcbiAgICAgICAgaWYgKG1lLmNvbmZpZy5ub3RpZnkpIHtcbiAgICAgICAgICAgIG1lLmNvbmZpZy5ub3RpZnkuZm9yRWFjaCgodGltZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0aW1lIDwgMSlcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB0aGUgbm90aWZ5IGNvbmZpZyBtdXN0IGJlIGEgcG9zaXRpdmUgaW50ZWdlci5gKTtcbiAgICAgICAgICAgICAgICB0aW1lID0gdGltZSAqIDEwMDA7XG4gICAgICAgICAgICAgICAgdGltZSA9IHRpbWUgLSAodGltZSAlIG1lLmZyZXF1ZW5jeSk7XG4gICAgICAgICAgICAgICAgbWUuX25vdGlmeVt0aW1lXSA9IHRydWU7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBtZS50aW1lci5hZGQobWUucmVmbG93LCBtZS5mcmVxdWVuY3kpO1xuICAgICAgICAvLyBzaG93XG4gICAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSAnaW5saW5lJztcbiAgICAgICAgdGhpcy50aW1lci5zdGFydCgpO1xuICAgICAgICByZXR1cm4gbWU7XG4gICAgfVxuICAgIGRlc3Ryb3koKSB7XG4gICAgICAgIHRoaXMudGltZXIucmVtb3ZlKHRoaXMucmVmbG93KTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIOabtOaWsOaXtumSn1xuICAgICAqL1xuICAgIHJlZmxvdyhjb3VudCA9IDAsIGZvcmNlID0gZmFsc2UpIHtcbiAgICAgICAgY29uc3QgbWUgPSB0aGlzO1xuICAgICAgICBpZiAoIWZvcmNlICYmIChtZS5wYXVzZWQgfHwgbWUuc3RvcGVkKSlcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgbWUubGVmdCA9IG1lLmxlZnQgLSBtZS5mcmVxdWVuY3kgKiBjb3VudDtcbiAgICAgICAgbWUuaGFuZHMuZm9yRWFjaCgoaGFuZCkgPT4ge1xuICAgICAgICAgICAgaGFuZC5sYXN0VmFsdWUgPSBoYW5kLnZhbHVlO1xuICAgICAgICAgICAgaGFuZC52YWx1ZSA9IE1hdGguZmxvb3IobWUubGVmdCAvIGhhbmQuYmFzZSkgJSBoYW5kLnJhZGl4O1xuICAgICAgICB9KTtcbiAgICAgICAgbWUucmVwYWludCgpO1xuICAgICAgICBpZiAobWUuX25vdGlmeVttZS5sZWZ0XSkge1xuICAgICAgICAgICAgbWUubm90aWZ5LmVtaXQobWUubGVmdCk7XG4gICAgICAgICAgICBtZS5jYWxsRXZlbnQoJ25vdGlmeScpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChtZS5sZWZ0IDwgMSkge1xuICAgICAgICAgICAgbWUuZmluaXNoZWQuZW1pdCgwKTtcbiAgICAgICAgICAgIG1lLnN0b3BlZCA9IHRydWU7XG4gICAgICAgICAgICBtZS5jYWxsRXZlbnQoJ2ZpbmlzaGVkJyk7XG4gICAgICAgICAgICBtZS5kZXN0cm95KCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLyoqXG4gICAgICog6YeN57uY5pe26ZKfXG4gICAgICovXG4gICAgcmVwYWludCgpIHtcbiAgICAgICAgY29uc3QgbWUgPSB0aGlzO1xuICAgICAgICBpZiAobWUuY29uZmlnLnJlcGFpbnQpIHtcbiAgICAgICAgICAgIG1lLmNvbmZpZy5yZXBhaW50LmFwcGx5KG1lKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBsZXQgY29udGVudDtcbiAgICAgICAgbWUuaGFuZHMuZm9yRWFjaCgoaGFuZCkgPT4ge1xuICAgICAgICAgICAgaWYgKGhhbmQubGFzdFZhbHVlICE9PSBoYW5kLnZhbHVlKSB7XG4gICAgICAgICAgICAgICAgY29udGVudCA9ICcnO1xuICAgICAgICAgICAgICAgIG1lLnRvRGlnaXRhbHMoaGFuZC52YWx1ZSwgaGFuZC5iaXRzKS5mb3JFYWNoKChkaWdpdGFsKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnQgKz0gbWUuaHRtbChkaWdpdGFsLnRvU3RyaW5nKCksICcnLCAnZGlnaXRhbCcpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGhhbmQubm9kZS5pbm5lckhUTUwgPSBjb250ZW50O1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgLyoqXG4gICAgICog6I635Y+W5YCS6K6h5pe25Ymp5L2Z5bin5pWwXG4gICAgICovXG4gICAgZ2V0TGVmdCgpIHtcbiAgICAgICAgY29uc3QgbWUgPSB0aGlzO1xuICAgICAgICBsZXQgbGVmdCA9IG1lLmNvbmZpZy5sZWZ0VGltZSAqIDEwMDA7XG4gICAgICAgIGNvbnN0IGVuZCA9IG1lLmNvbmZpZy5zdG9wVGltZTtcbiAgICAgICAgaWYgKCFsZWZ0ICYmIGVuZClcbiAgICAgICAgICAgIGxlZnQgPSBlbmQgLSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICAgICAgbWUubGVmdCA9IGxlZnQgLSAobGVmdCAlIG1lLmZyZXF1ZW5jeSk7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIOeUn+aIkOmcgOimgeeahGh0bWzku6PnoIHvvIzovoXliqnlt6XlhbdcbiAgICAgKi9cbiAgICBodG1sKGNvbiwgY2xhc3NOYW1lLCB0eXBlKSB7XG4gICAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICAgICAgY2FzZSAnaGFuZCc6XG4gICAgICAgICAgICBjYXNlICdoYW5kbGV0JzpcbiAgICAgICAgICAgICAgICBjbGFzc05hbWUgPSB0eXBlICsgJyBoYW5kLScgKyBjbGFzc05hbWU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdkaWdpdGFsJzpcbiAgICAgICAgICAgICAgICBpZiAoY29uID09PSAnLicpIHtcbiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gdHlwZSArICcgJyArIHR5cGUgKyAnLXBvaW50ICcgKyBjbGFzc05hbWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWUgPSB0eXBlICsgJyAnICsgdHlwZSArICctJyArIGNvbiArICcgJyArIGNsYXNzTmFtZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICc8c3BhbiBjbGFzcz1cIicgKyBjbGFzc05hbWUgKyAnXCI+JyArIGNvbiArICc8L3NwYW4+JztcbiAgICB9XG4gICAgLyoqXG4gICAgICog5oqK5YC86L2s5o2i5Li654us56uL55qE5pWw5a2X5b2i5byPXG4gICAgICovXG4gICAgdG9EaWdpdGFscyh2YWx1ZSwgYml0cykge1xuICAgICAgICB2YWx1ZSA9IHZhbHVlIDwgMCA/IDAgOiB2YWx1ZTtcbiAgICAgICAgY29uc3QgZGlnaXRhbHMgPSBbXTtcbiAgICAgICAgLy8g5oqK5pe244CB5YiG44CB56eS562J5o2i566X5oiQ5pWw5a2XLlxuICAgICAgICB3aGlsZSAoYml0cy0tKSB7XG4gICAgICAgICAgICBkaWdpdGFsc1tiaXRzXSA9IHZhbHVlICUgMTA7XG4gICAgICAgICAgICB2YWx1ZSA9IE1hdGguZmxvb3IodmFsdWUgLyAxMCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGRpZ2l0YWxzO1xuICAgIH1cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgdGhpcy5pbml0KCk7XG4gICAgICAgIGlmICghdGhpcy5jb25maWcuZGVtYW5kKVxuICAgICAgICAgICAgdGhpcy5iZWdpbigpO1xuICAgIH1cbiAgICBuZ09uRGVzdHJveSgpIHtcbiAgICAgICAgdGhpcy5kZXN0cm95KCk7XG4gICAgfVxuICAgIG5nT25DaGFuZ2VzKGNoYW5nZXMpIHtcbiAgICAgICAgaWYgKCFjaGFuZ2VzLmNvbmZpZy5maXJzdENoYW5nZSkge1xuICAgICAgICAgICAgdGhpcy5yZXN0YXJ0KCk7XG4gICAgICAgIH1cbiAgICB9XG59XG5Db3VudGRvd25Db21wb25lbnQuZGVjb3JhdG9ycyA9IFtcbiAgICB7IHR5cGU6IENvbXBvbmVudCwgYXJnczogW3tcbiAgICAgICAgICAgICAgICBzZWxlY3RvcjogJ2NvdW50ZG93bicsXG4gICAgICAgICAgICAgICAgdGVtcGxhdGU6IGBcbiAgICA8bmctY29udGVudD48L25nLWNvbnRlbnQ+XG4gIGAsXG4gICAgICAgICAgICAgICAgaG9zdDogeyAnW2NsYXNzLmNvdW50LWRvd25dJzogJ3RydWUnIH0sXG4gICAgICAgICAgICAgICAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZSxcbiAgICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbiAgICAgICAgICAgICAgICBzdHlsZXM6IFtgXG4gICAgICBjb3VudGRvd24ge1xuICAgICAgICBkaXNwbGF5OiBub25lO1xuICAgICAgfVxuICAgIGBdXG4gICAgICAgICAgICB9XSB9XG5dO1xuLyoqIEBub2NvbGxhcHNlICovXG5Db3VudGRvd25Db21wb25lbnQuY3RvclBhcmFtZXRlcnMgPSAoKSA9PiBbXG4gICAgeyB0eXBlOiBFbGVtZW50UmVmIH0sXG4gICAgeyB0eXBlOiBUaW1lciB9LFxuICAgIHsgdHlwZTogQ291bnRkb3duQ29uZmlnIH1cbl07XG5Db3VudGRvd25Db21wb25lbnQucHJvcERlY29yYXRvcnMgPSB7XG4gICAgY29uZmlnOiBbeyB0eXBlOiBJbnB1dCB9XSxcbiAgICBzdGFydDogW3sgdHlwZTogT3V0cHV0IH1dLFxuICAgIGZpbmlzaGVkOiBbeyB0eXBlOiBPdXRwdXQgfV0sXG4gICAgbm90aWZ5OiBbeyB0eXBlOiBPdXRwdXQgfV0sXG4gICAgZXZlbnQ6IFt7IHR5cGU6IE91dHB1dCB9XVxufTtcbiJdfQ==